import{r as t,bu as $,x as w}from"./index-ChJwsExv.js";function G(L){const{maxSizeMB:f=5,compressQuality:I=.2,compressConvertSize:R=1e6,logPerf:F=!1,buildFormData:S,formFieldName:k="file",t:d,i18nKeys:i}=L||{},u=t.useRef(null),[x,g]=t.useState(!1),[N,z]=t.useState({x:0,y:0}),[j,M]=t.useState(1),[T,b]=t.useState(""),[c,v]=t.useState(""),[E,p]=t.useState(),h=t.useRef(null),U=(i==null?void 0:i.onlyImage)||"configBase.onlyUploadImage",B=(i==null?void 0:i.fileTooLarge)||"configBase.fileSizeCannotExceed5MB",W=t.useCallback(()=>{g(!1),z({x:0,y:0}),M(1),b(""),v(""),p(void 0),h.current=null,u.current&&(u.current.value="")},[]),H=t.useCallback(()=>{u.current&&(u.current.value="",u.current.click())},[]),D=t.useCallback((l,o,e)=>new Promise((s,r)=>{new $(l,{quality:o,convertSize:e,success(a){const m=new File([a],a.name||"compressed-image.jpeg",{type:a.type,lastModified:a.lastModified});s(m)},error(a){r(a)}})}),[]),C=t.useCallback((l,o)=>{if(!l||!o)return;const e=new Image;e.src=l,e.onload=()=>{const s=document.createElement("canvas");s.width=o.width,s.height=o.height;const r=s.getContext("2d");r&&r.drawImage(e,o.x*(e.width/e.naturalWidth),o.y*(e.height/e.naturalHeight),o.width*(e.width/e.naturalWidth),o.height*(e.height/e.naturalHeight),0,0,o.width,o.height),s.toBlob(a=>{if(a)if(S)p(S(a));else{const m=new FormData;m.append(k,a,"cropped-image.jpeg"),p(m)}},"image/jpeg",1)}},[S,k]);t.useEffect(()=>{c&&h.current&&C(c,h.current)},[c,C]);const O=t.useCallback(l=>{const o=performance.now(),e=l.target.files;if(!e||e.length===0)return;const s=e[0];if(v(""),p(void 0),!s.type.startsWith("image/")){d?w.error(d(U)):w.error("只能上传图片");return}if(console.log("file.size",s.size),s.size>f*1024*1024){d?w.error(d(B,{size:f})):w.error(`文件大小不能超过${f}MB`);return}const r=new FileReader,a=performance.now();r.addEventListener("load",()=>{const n=performance.now();F&&console.log("[useImageCropUpload] 原图读取耗时(ms):",{总耗时:Number((n-o).toFixed(2)),读取:Number((n-a).toFixed(2))}),b(r.result),g(!0)}),r.readAsDataURL(s);const m=performance.now();D(s,I,R).then(n=>{const _=performance.now();F&&console.log("[useImageCropUpload] 压缩耗时(ms):",Number((_-m).toFixed(2)));const y=new FileReader;y.addEventListener("load",()=>{v(y.result)}),y.readAsDataURL(n)}).catch(n=>{console.warn("[useImageCropUpload] 压缩失败，使用原图作为兜底：",(n==null?void 0:n.message)||n)})},[R,D,I,F,f,d,B,U]),Q=t.useCallback((l,o)=>{h.current=o,c&&C(c,o)},[c,C]),V=t.useCallback(()=>g(!0),[]),Z=t.useCallback(()=>{g(!1),b(""),M(1)},[]);return{inputRef:u,triggerFileSelectPopup:H,onFileChange:O,visible:x,openModal:V,closeModal:Z,crop:N,setCrop:z,zoom:j,setZoom:M,onCropComplete:Q,uploadedSrc:T,compressedSrc:c,formData:E,isFormReady:!!E,reset:W}}export{G as u};
