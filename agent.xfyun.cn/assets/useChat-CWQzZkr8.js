import{bi as r,r as _,c as Pt,au as Mt,at as et,aw as xt,ax as bt,dc as Lt,dd as Nt,de as Ft,az as $t,ay as Jt,df as Ot,dg as Et,dh as Bt,di as Ut,x as Vt,bp as Gt}from"./index-ChJwsExv.js";let P="";function qt(){const w=r(t=>t.addTempAns),J=r(t=>t.addMessage),ot=r(t=>t.addTempAnsToList),h=r(t=>t.setIsLoading),O=r(t=>t.setCurrentChatId),E=r(t=>t.setIsAnswerLoading),B=r(t=>t.setAllToolsCurrent),at=_.useRef(""),S=_.useRef(""),d=_.useRef(null),ct=r(t=>t.setControllerRef),U=r(t=>t.setCurrentMathThink),V=r(t=>t.setDeepThinkPeriod),M=r(t=>t.setAnswerPercent),y=r(t=>t.setIsAnswerPercent),it=r(t=>t.traceSource),lt=r(t=>t.setTraceSource),ut=r(t=>t.setSourceType),ft=r(t=>t.chatFileList),G=r(t=>t.currentChatId),pt=r(t=>t.setFd),ht=r(t=>t.inputValue),A=r(t=>t.messageList),x=r(t=>t.setWorkflowOperation),R=r(t=>t.setIsWorkflowOptions),q=r(t=>t.setWorkflowOption),b=r(t=>t.setMultiAudioPlayStatus),dt=r(t=>t.multiAudioPlayStatus),gt=r(t=>t.setMultiAudioPlaySid),wt=r(t=>t.setIsAudioPlaying),St=r(t=>t.multiAudioRef),k=_.useRef(""),W=r(t=>t.setAudioSource),z=r(t=>t.getAudioSource),At=Pt(),Tt=async()=>{if(A.length>0&&A[A.length-1].role!=="START"){const t=new URLSearchParams;t.append("chatId",G),await Gt(t),J({reqId:"START",content:""})}},L=t=>{E(!1),y(!1),h(!1),M(0),ot({sid:S.current,id:Date.now(),type:k.current,rawData:P}),t==="abort"&&(x({}),Tt())},H=async(t,a,p,c)=>{let o="",u="",i=!1,f="",l="",T=!1;y(!1),M(0),B([]);let g=[],N=null,F=[],X=!1;P="";const I=new AbortController;d.current=I,k.current="",ct(d.current);const _t={Challenge:c==null?void 0:c.geetest_challenge,Seccode:et.encode((c==null?void 0:c.geetest_seccode)||""),Validate:c==null?void 0:c.geetest_validate,clientType:"11","Lang-Code":Mt()};p&&(a==null||a.append("GtToken",p)),J({id:Date.now(),message:(()=>{try{const n=JSON.parse(a.get("text")||"{}");return(n==null?void 0:n.id)||a.get("text")}catch{return a.get("text")}})(),updateTime:new Date().toISOString(),reqId:"USER",chatFileList:ft}),h(!0),E(!0),xt(t,{method:"POST",body:a,headers:{..._t},openWhenHidden:!0,signal:I.signal,onopen(n){return Promise.resolve()},onmessage(n){var Y,Z,C,j,D,v,m,tt,st,nt,rt;const s=bt(n.data);if(n.data==="<end>"&&!u&&!f){i=!0;return}else if(n.data==="<end>"&&u){try{const e=JSON.parse(u.replace(/^\[.*?\]/,""));w(e==null?void 0:e.value),(e==null?void 0:e.key)===20002&&(window.onbeforeunload=null)}catch(e){console.log(e)}setTimeout(()=>{L()},50),I.abort("结束");return}else n.data;if(n.data==="[error]"){u+=n.data;return}if(n.data==="[belongerr]"&&window.location.reload(),n.data==="<kx>"){console.log("触发了快修");return}if(!((Y=n.data)!=null&&Y.endsWith("<sid>"))&&(s!=null&&s.startsWith("```searchSource")||s!=null&&s.startsWith("```fileMultiTrace")||s!=null&&s.startsWith("```ragMultiTrace")||s!=null&&s.startsWith("```zdmSource"))){l=Lt(s),ut(l),lt(Nt(it,s));return}if(!((Z=n.data)!=null&&Z.endsWith("<sid>"))&&(s!=null&&s.startsWith("```allTool"))){g=Ft(g,s),B((g==null?void 0:g.length)>0?JSON.stringify(g):"");return}if(!(!((C=n.data)!=null&&C.endsWith("<sid>"))&&(s!=null&&s.startsWith("```temporary_jump")))){if(!((j=n.data)!=null&&j.endsWith("<sid>"))&&(s!=null&&s.startsWith("<deep_x1>"))){F=$t({setV2Trace:e=>e},s,F),V(F);return}if(!((D=n.data)!=null&&D.endsWith("<sid>"))&&(s!=null&&s.startsWith("<math_thinking")||s!=null&&s.startsWith("<thinking"))){N=Jt(s,N),U({...N});return}if(!((v=n.data)!=null&&v.endsWith("<sid>"))&&(s!=null&&s.startsWith("```taskCompletion"))){const e=Ot(s),$=Math.floor(parseFloat(e)*100);Number.isNaN($)||(M($),$>=100?y(!1):y(!0));return}if(s!=null&&s.startsWith("<workflow_operation>")){x(JSON.parse(s.replace("<workflow_operation>",""))),T=!0;return}if(T||x({}),s!=null&&s.startsWith("<workflow_direct>")){o=`${o}
${(m=JSON.parse(s.replace("<workflow_direct>","")))==null?void 0:m.content}`,w(o);return}if(s!=null&&s.startsWith("<workflow_option>")){R(!0),q({option:(tt=JSON.parse(s.replace("<workflow_option>","")))==null?void 0:tt.option,content:(st=JSON.parse(s.replace("<workflow_option>","")))==null?void 0:st.content});return}if(X||!((nt=n.data)!=null&&nt.endsWith("<sid>"))&&(s!=null&&s.startsWith("```multi_audio"))){X=!0,k.current="multi_audio";const e=Et(n.data);(e==null?void 0:e.type)==="instruction"?o=e==null?void 0:e.content:(e==null?void 0:e.type)==="stream"?P+=Bt(e.audio):(e==null?void 0:e.type)==="sid"?(S.current=(e==null?void 0:e.sid)||"",h(!1),dt==="loading"&&K(P,S.current),w(o),L()):console.warn("数据不符合规范");return}if(!((rt=n.data)!=null&&rt.endsWith("<sid>"))&&(s!=null&&s.startsWith("```multi"))&&!(s!=null&&s.startsWith("```multi_image_url"))&&(o==null?void 0:o.length)<=0){k.current="video",o=n.data,w(o);return}if(!u&&!f){if(h(!1),i){at.current=o,S.current=n.data.split("<sid>")[0],L(a.get("workflowOperation")),I.abort("结束");return}if(o=`${o}${et.decode(n.data)}`,o.includes("<source")&&!o.includes("</audio>"))return;w(o)}else u+=n.data,n.data.includes("<sid>")&&(S.current=n.data.split("<sid>")[0])}},onerror(n){throw h(!1),d.current.abort("结束"),console.warn("esError",n),n}}).catch(n=>{h(!1),d.current.abort("结束"),console.log(n)})},yt=()=>{d.current&&d.current.abort()},kt=t=>{(t!=null&&t.chatId||t!=null&&t.id)&&O((t==null?void 0:t.chatId)||(t==null?void 0:t.id)),At(`/chat?botId=${t==null?void 0:t.botId}`)},Wt=t=>{let a=`${location.origin}/chat?botId=${t==null?void 0:t.botId}`;t!=null&&t.version&&(a+=`&version=${t==null?void 0:t.version}`),window.open(a,"_blank"),(t!=null&&t.chatId||t!=null&&t.id)&&O((t==null?void 0:t.chatId)||(t==null?void 0:t.id))},It=async(t,a,p,c)=>{var T;U({current_title:"",text:"",thinking_cost:void 0}),R(!1),q(""),V([]);const o=await Ut(),u=String(+new Date),i=u.substring(u.length-6);pt(i);const f="/xingchen-api/u/chat_message/chat",l=new FormData;l.append("fd",i),l.append("isBot","1"),l.append("clientType","11"),l.append("category","2"),l.append("text",t||ht),l.append("chatId",G),l.append("sid",((T=A[A.length-1])==null?void 0:T.sid)||""),l.append("workflowVersion",p||""),a&&l.append("workflowOperation",a),c&&l.append("talkAgentInteract",c.toString()),H(f,l,o)},K=(t,a)=>{wt(!1),Q(),gt(a);const p=new Uint8Array(t.length);for(let i=0;i<t.length;++i)p[i]=t.charCodeAt(i);const c=z();c!=null&&c.buffer&&W(null);const o=p.buffer,u=new(window.AudioContext||window.webkitAudioContext);u.decodeAudioData(o,i=>{const f=u.createBufferSource();f.buffer=i,f.connect(u.destination),f.start(0),b("play"),W(f),f.onended=()=>{b("stop"),W(null)}},i=>{console.warn(i),Vt.error(i)})},Q=()=>{var a;(a=St.current)==null||a.pause();const t=z();t&&(t.stop(),W(null)),b("stop")};return{fetchSSE:H,cancelFetchSSE:yt,handleToChat:kt,handleFlowToChat:Wt,onSendMsg:It,playBase64:K,stopPlaySource:Q}}export{qt as u};
